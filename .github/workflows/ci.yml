name: CI/CD - Lint and Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Passo 1: Configurar Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20" # Use a versão do Node.js que seu projeto utiliza
          # Remova a linha 'cache: pnpm' aqui, pois vamos instalar o pnpm explicitamente.
          # O cache será gerenciado automaticamente pelo pnpm após a instalação.

      # Passo 2: Instalar pnpm globalmente
      # Este passo garante que o pnpm esteja disponível no PATH
      - name: Install pnpm
        run: npm install -g pnpm

      # Passo 3: Instalar dependências com pnpm
      - name: Install dependencies with pnpm
        run: pnpm install --frozen-lockfile

      # Passo 4: Rodar ESLint com pnpm
      - name: Run ESLint with pnpm
        run: pnpm lint

      # Passo 5: Rodar Testes Jest/RTL com pnpm
      - name: Run Tests with pnpm
        run: pnpm test
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:3000/api

      # Opcional: Upload de resultados de cobertura de código
      # - name: Upload coverage reports to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     files: ./coverage/lcov.info
      #     verbose: true
